<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chain Forensic Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; color: #0F172A; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card { background: white; border: 1px solid #E2E8F0; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .btn-pattern { cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; color: #64748B; background: #F1F5F9; transition: all 0.2s; }
        .btn-pattern:hover { background: #E2E8F0; color: #0F172A; }
        
        /* Loading Animation */
        .loader { border-top-color: #10B981; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-white border-b border-slate-200 sticky top-0 z-10">
        <div class="container mx-auto p-4 max-w-lg">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight leading-none">CHAIN FORENSIC<br><span class="text-green-600">ANALYZER</span></h1>
                </div>
                <button id="connect-btn" onclick="connectWallet()" class="bg-slate-900 hover:bg-slate-800 text-white text-xs font-bold py-2 px-4 rounded-lg transition flex items-center gap-2">
                    <i data-lucide="wallet" class="w-4 h-4"></i> CONNECT WALLET
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 max-w-lg flex-grow">
        
        <div class="flex justify-between items-center mb-6 text-xs text-slate-500 font-mono">
            <div class="flex items-center gap-2">
                <span class="bg-green-100 text-green-800 px-1.5 py-0.5 rounded">v3.0.PAY</span>
                <span>SOLANA MAINNET</span>
            </div>
            <div class="flex items-center gap-1">
                <span>FEE:</span>
                <span class="text-green-600 font-bold">0.000015 SOL</span>
            </div>
        </div>

        <div class="relative mb-3">
            <input type="text" id="token-input" placeholder="Enter contract address..." 
                class="w-full pl-10 pr-24 py-3 bg-white border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500 mono text-sm">
            <i data-lucide="search" class="absolute left-3 top-3.5 text-slate-400 w-4 h-4"></i>
            <button onclick="runPaidAudit()" class="absolute right-1 top-1 bottom-1 bg-green-700 hover:bg-green-800 text-white px-4 rounded-md text-xs font-bold tracking-wide flex items-center gap-1">
                PAY & SCAN
            </button>
        </div>

        <div class="flex flex-wrap gap-2 items-center mb-8">
            <span class="text-xs text-slate-400 font-bold uppercase mr-1">Triggers:</span>
            <div onclick="simulate('bundle')" class="btn-pattern text-orange-600">BUNDLE</div>
            <div onclick="simulate('rugpull')" class="btn-pattern text-red-800 font-bold">RUGPULL</div>
            <div onclick="simulate('safe')" class="btn-pattern text-green-600">SAFE</div>
        </div>

        <div id="loading-ui" class="hidden py-12 text-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
            <h2 id="loading-text" class="text-slate-600 font-semibold animate-pulse">Processing Payment...</h2>
            <p class="text-xs text-slate-400 mt-2">Please approve transaction in your wallet</p>
        </div>

        <div id="results-ui" class="space-y-4 hidden">
            <div class="card p-5">
                <h3 class="text-green-600 font-mono font-bold text-lg mb-4">Token Intelligence</h3>
                <div class="grid grid-cols-2 gap-y-4 text-sm">
                    <div>
                        <div class="text-slate-400 text-xs">Symbol</div>
                        <div class="font-bold text-slate-800" id="data-symbol">--</div>
                    </div>
                    <div>
                        <div class="text-slate-400 text-xs">Price</div>
                        <div class="font-mono text-slate-800" id="data-price">--</div>
                    </div>
                </div>
            </div>

            <div class="card p-5">
                <h3 class="text-green-600 font-mono font-bold text-lg mb-4">Supply Analysis</h3>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-slate-500 text-sm">Risk Score</span>
                    <span class="font-mono text-xl font-bold" id="score-liquidity">--/100</span>
                </div>
                <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden flex" id="supply-bar">
                    <div class="h-full bg-slate-300 w-full"></div>
                </div>
            </div>

            <div class="card p-5">
                <h3 class="text-green-600 font-mono font-bold text-lg mb-4">Behavioral Analysis</h3>
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded">
                    <span class="text-sm text-slate-600">Anomaly Detection</span>
                    <span class="text-xs font-bold px-2 py-1 rounded" id="anomaly-badge">--</span>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- CONFIGURATION ---
        const BACKEND_URL = "https://holistic-auditor.onrender.com"; 
        
        // !!! PASTE YOUR WALLET ADDRESS HERE !!!
        const TREASURY_WALLET = "PUT_YOUR_SOLANA_WALLET_ADDRESS_HERE"; 
        const AUDIT_FEE = 0.000015; // SOL

        // --- WALLET CONNECTION ---
        let userWallet = null;

        async function connectWallet() {
            if (window.solana && window.solana.isPhantom) {
                try {
                    const resp = await window.solana.connect();
                    userWallet = resp.publicKey.toString();
                    
                    // Update UI
                    const btn = document.getElementById('connect-btn');
                    btn.innerText = userWallet.slice(0, 4) + '...' + userWallet.slice(-4);
                    btn.classList.remove('bg-slate-900');
                    btn.classList.add('bg-green-600');
                } catch (err) {
                    alert("Connection rejected!");
                }
            } else {
                alert("Phantom Wallet not found. Please install it!");
                window.open("https://phantom.app/", "_blank");
            }
        }

        // --- THE PAYMENT LOGIC ---
        async function runPaidAudit() {
            const address = document.getElementById('token-input').value;
            if (!address) return alert("Enter a token address");

            // 1. Check Wallet
            if (!userWallet) {
                await connectWallet();
                if (!userWallet) return; // User cancelled
            }

            // 2. Start Payment Process
            document.getElementById('loading-ui').classList.remove('hidden');
            document.getElementById('results-ui').classList.add('hidden');
            document.getElementById('loading-text').innerText = "Processing Payment...";

            if (address.includes("SIMULATION")) {
                // Skip payment for simulations
                setTimeout(() => runActualAudit(address), 1000);
                return;
            }

            try {
                // Setup Transaction
                const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: new solanaWeb3.PublicKey(userWallet),
                        toPubkey: new solanaWeb3.PublicKey(TREASURY_WALLET),
                        lamports: AUDIT_FEE * solanaWeb3.LAMPORTS_PER_SOL
                    })
                );

                const { blockhash } = await connection.getLatestBlockhash();
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = new solanaWeb3.PublicKey(userWallet);

                // Request Sign & Send
                const { signature } = await window.solana.signAndSendTransaction(transaction);
                
                document.getElementById('loading-text').innerText = "Confirming on Blockchain...";
                
                // Wait for confirmation
                await connection.confirmTransaction(signature);
                
                // Payment Success! Run the Audit
                runActualAudit(address);

            } catch (err) {
                console.error(err);
                alert("Transaction Failed or Cancelled.");
                document.getElementById('loading-ui').classList.add('hidden');
            }
        }

        // --- THE AUDIT LOGIC (Runs after payment) ---
        async function runActualAudit(address) {
            document.getElementById('loading-text').innerText = "Triangulating Data...";

            try {
                // Simulation Mode Bypass
                if(address.includes("SIMULATION")) {
                    const type = address.split("_")[2].toLowerCase();
                    const mock = getMockData(type);
                    updateUI(mock);
                    return;
                }

                // Real Backend Call
                const res = await fetch(`${BACKEND_URL}/audit`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({address})
                });
                const data = await res.json();
                
                // Convert Backend Data to UI Format
                const uiData = {
                    symbol: "UNK", // Your backend needs to return this
                    price: data.pillars.behavior.price || "--",
                    score: data.overall_score,
                    risk: data.overall_score > 80 ? "SAFE" : "HIGH"
                };
                updateUI(uiData);

            } catch (e) {
                alert("Audit Error: " + e.message);
                document.getElementById('loading-ui').classList.add('hidden');
            }
        }

        // --- UI UPDATER ---
        function updateUI(data) {
            document.getElementById('loading-ui').classList.add('hidden');
            document.getElementById('results-ui').classList.remove('hidden');

            document.getElementById('data-symbol').innerText = data.symbol || "TOKEN";
            document.getElementById('data-price').innerText = data.price ? `$${data.price}` : "--";
            document.getElementById('score-liquidity').innerText = data.score + "/100";
            
            // Color Coding
            const scoreEl = document.getElementById('score-liquidity');
            const badgeEl = document.getElementById('anomaly-badge');
            
            if (data.score > 80) {
                scoreEl.className = "font-mono text-xl font-bold text-green-600";
                badgeEl.innerText = "SAFE";
                badgeEl.className = "text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-800";
            } else {
                scoreEl.className = "font-mono text-xl font-bold text-red-600";
                badgeEl.innerText = "CRITICAL RISK";
                badgeEl.className = "text-xs font-bold px-2 py-1 rounded bg-red-100 text-red-800";
            }
        }

        // --- SIMULATION DATA ---
        function simulate(type) {
            document.getElementById('token-input').value = "0xSIMULATION_MODE_" + type.toUpperCase();
            runPaidAudit(); // Triggers the flow but skips payment
        }
        
        function getMockData(type) {
            if(type === 'bundle') return { symbol: "SCAM", price: "0.004", score: 15 };
            if(type === 'rugpull') return { symbol: "RUG", price: "0.00001", score: 0 };
            return { symbol: "SAFE", price: "1.20", score: 98 };
        }

        lucide.createIcons();
    </script>
</body>
</html>

