<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holistic Forensic Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        body { background-color: #0B1120; color: #E2E8F0; font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card { background: #1E293B; border: 1px solid #334155; border-radius: 8px; }
        .forensic-panel { border-left: 3px solid; }
        .panel-immutable { border-color: #3B82F6; } /* Blue for Code */
        .panel-mutable { border-color: #10B981; }   /* Green for Behavior */
        
        /* Grid Pattern Background */
        .bg-grid { background-image: radial-gradient(#334155 1px, transparent 1px); background-size: 20px 20px; }
        
        .loader { border-top-color: #10B981; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen bg-grid">

    <header class="border-b border-slate-700 bg-slate-900/80 backdrop-blur sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded">
                    <i data-lucide="shield-search" class="text-white w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-none tracking-tight">CHAIN FORENSICS</h1>
                    <div class="text-[10px] text-slate-400 mono">V3.1.0 // DUAL THEOLOGY ENGINE</div>
                </div>
            </div>
            <button id="connect-btn" onclick="connectWallet()" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 text-xs font-bold py-2 px-4 rounded transition flex items-center gap-2">
                <i data-lucide="wallet" class="w-4 h-4"></i> CONNECT SOLANA
            </button>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">

        <div class="max-w-2xl mx-auto mb-12 text-center">
            <h2 class="text-3xl font-extrabold text-white mb-2">Reveal The Invisible.</h2>
            <p class="text-slate-400 mb-6 text-sm">Triangulate Code, Supply, and Behavior to detect "Soft Rugs" other scanners miss.</p>
            
            <div class="relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-green-600 rounded-lg blur opacity-25 group-hover:opacity-50 transition duration-1000"></div>
                <div class="relative flex">
                    <input type="text" id="token-input" placeholder="Enter Token Address..." 
                        class="w-full bg-slate-900 border border-slate-700 text-white px-6 py-4 rounded-l-lg focus:outline-none focus:border-blue-500 mono">
                    <button onclick="runPaidAudit()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-8 py-4 rounded-r-lg flex items-center gap-2 transition">
                        <span>SCAN</span>
                        <span class="bg-blue-800 text-[10px] py-1 px-2 rounded ml-1">0.015 SOL</span>
                    </button>
                </div>
            </div>

            <div class="mt-4 flex justify-center gap-3 text-xs mono">
                <span class="text-slate-500">SIMULATE:</span>
                <button onclick="simulate('bundle')" class="text-orange-400 hover:underline">BUNDLE</button>
                <button onclick="simulate('wash')" class="text-blue-400 hover:underline">WASH TRADING</button>
                <button onclick="simulate('safe')" class="text-green-400 hover:underline">SAFE TOKEN</button>
            </div>
        </div>

        <div id="loading-ui" class="hidden fixed inset-0 bg-slate-900/90 z-40 flex flex-col items-center justify-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-700 h-16 w-16 mb-6"></div>
            <div class="text-xl font-bold text-white mb-2 animate-pulse" id="loading-text">Processing Payment...</div>
            <div class="text-sm text-slate-400 mono">Triangulating On-Chain Data Points</div>
        </div>

        <div id="results-ui" class="hidden">
            
            <div class="card p-6 mb-8 flex flex-col md:flex-row justify-between items-center border-l-4" id="verdict-banner">
                <div>
                    <div class="text-sm text-slate-400 uppercase tracking-widest font-bold mb-1">Forensic Verdict</div>
                    <h2 class="text-3xl font-bold text-white" id="verdict-title">--</h2>
                    <p class="text-sm text-slate-400 mt-1 max-w-xl" id="verdict-desc">--</p>
                </div>
                <div class="text-right mt-4 md:mt-0">
                    <div class="text-5xl font-mono font-bold" id="verdict-score">--</div>
                    <div class="text-xs text-slate-500 uppercase mt-1">Safety Score</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                <div class="space-y-6">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="box" class="text-blue-500"></i>
                        <h3 class="font-bold text-slate-200">THEOLOGY A: CODE & SUPPLY</h3>
                    </div>

                    <div class="card p-5 forensic-panel panel-immutable">
                        <div class="flex justify-between mb-4">
                            <h4 class="font-bold text-sm text-slate-300">Supply Clustering (The "Bundle")</h4>
                            <span class="text-xs bg-slate-800 px-2 py-1 rounded text-blue-400 border border-blue-900/30">Forensic Angle A</span>
                        </div>
                        <div class="h-64 relative bg-slate-900/50 rounded flex items-center justify-center overflow-hidden">
                            <canvas id="clusterChart"></canvas>
                        </div>
                        <div class="mt-4 text-xs text-slate-400 bg-slate-800 p-3 rounded border border-slate-700">
                            <strong class="text-blue-400">Why this matters:</strong> 
                            <span id="cluster-insight">Scammers split tokens into 20+ wallets to look decentralized. Our "Spider Web" algorithm detects if these wallets were funded by the same source.</span>
                        </div>
                    </div>

                    <div class="card p-5">
                        <h4 class="font-bold text-sm text-slate-300 mb-4">Holder Concentration</h4>
                        <div class="flex gap-4 items-center">
                            <div class="w-1/3">
                                <canvas id="holderPieChart"></canvas>
                            </div>
                            <div class="w-2/3 space-y-3 text-sm">
                                <div class="flex justify-between border-b border-slate-700 pb-1">
                                    <span class="text-slate-400">Top 10 Holders</span>
                                    <span class="font-mono text-white" id="data-top10">--%</span>
                                </div>
                                <div class="flex justify-between border-b border-slate-700 pb-1">
                                    <span class="text-slate-400">Dev Wallet</span>
                                    <span class="font-mono text-white" id="data-dev">--%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Unique Holders</span>
                                    <span class="font-mono text-white" id="data-unique">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="activity" class="text-green-500"></i>
                        <h3 class="font-bold text-slate-200">THEOLOGY B: HUMAN BEHAVIOR</h3>
                    </div>

                    <div class="card p-5 forensic-panel panel-mutable">
                        <div class="flex justify-between mb-4">
                            <h4 class="font-bold text-sm text-slate-300">Volume vs. Reality (Wash Trading)</h4>
                            <span class="text-xs bg-slate-800 px-2 py-1 rounded text-green-400 border border-green-900/30">Forensic Angle B</span>
                        </div>
                        <div class="h-48">
                            <canvas id="volumeChart"></canvas>
                        </div>
                        <div class="mt-4 text-xs text-slate-400 bg-slate-800 p-3 rounded border border-slate-700">
                            <strong class="text-green-400">Why this matters:</strong> 
                            <span id="volume-insight">High volume with low unique traders means the Dev is trading with himself to fake popularity (Wash Trading).</span>
                        </div>
                    </div>

                    <div class="card p-5">
                        <h4 class="font-bold text-sm text-slate-300 mb-4">Seller Behavior (Farming)</h4>
                        <div class="space-y-2">
                            <div class="grid grid-cols-3 text-xs text-slate-500 uppercase font-bold mb-2">
                                <div>Wallet Type</div>
                                <div class="text-center">Action</div>
                                <div class="text-right">Impact</div>
                            </div>
                            <div id="seller-rows" class="space-y-2 text-sm font-mono">
                                <div class="grid grid-cols-3 items-center bg-slate-800/50 p-2 rounded">
                                    <div class="text-orange-400">Early Buyer</div>
                                    <div class="text-center text-red-400">SOLD</div>
                                    <div class="text-right">-0.4 SOL</div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </main>

    <script>
        // --- CONFIG ---
        const BACKEND_URL = "https://holistic-auditor.onrender.com";
        const TREASURY_WALLET = "YOUR_WALLET_ADDRESS_HERE"; // <--- PASTE WALLET HERE
        const AUDIT_FEE = 0.000015;

        let userWallet = null;
        let clusterChartInstance = null;
        let volumeChartInstance = null;
        let holderChartInstance = null;

        // --- WALLET ---
        async function connectWallet() {
            if (window.solana && window.solana.isPhantom) {
                const resp = await window.solana.connect();
                userWallet = resp.publicKey.toString();
                document.getElementById('connect-btn').innerText = "CONNECTED: " + userWallet.slice(0,4) + "..";
                document.getElementById('connect-btn').classList.replace("bg-slate-800", "bg-blue-700");
            } else {
                alert("Please install Phantom Wallet");
            }
        }

        // --- PAYMENT & EXECUTION ---
        async function runPaidAudit() {
            const address = document.getElementById('token-input').value;
            if(!address) return alert("Enter Address");

            // SIMULATION BYPASS
            if(address.includes("SIMULATE")) return runSimulation(address.split(":")[1]);

            // PAYMENT FLOW
            if(!userWallet) await connectWallet();
            if(!userWallet) return;

            document.getElementById('loading-ui').classList.remove('hidden');

            try {
                // 1. Transaction
                const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: new solanaWeb3.PublicKey(userWallet),
                        toPubkey: new solanaWeb3.PublicKey(TREASURY_WALLET),
                        lamports: AUDIT_FEE * solanaWeb3.LAMPORTS_PER_SOL
                    })
                );
                const { blockhash } = await connection.getLatestBlockhash();
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = new solanaWeb3.PublicKey(userWallet);

                const { signature } = await window.solana.signAndSendTransaction(transaction);
                document.getElementById('loading-text').innerText = "Confirming Forensic Request...";
                await connection.confirmTransaction(signature);

                // 2. Fetch Data (Real)
                const res = await fetch(`${BACKEND_URL}/audit`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({address})
                });
                const data = await res.json();
                
                // Map to UI
                renderData({
                    score: data.overall_score,
                    type: data.overall_score > 80 ? "SAFE" : "RISK",
                    top10: "45%", // Real backend needs to return these specifics
                    dev: "2%",
                    holders: data.pillars.distribution.holder_count || 0
                });

            } catch(e) {
                console.error(e);
                alert("Transaction or Audit Failed");
                document.getElementById('loading-ui').classList.add('hidden');
            }
        }

        // --- SIMULATION (THEORETICAL KNOWLEDGE DISPLAY) ---
        function simulate(type) {
            document.getElementById('token-input').value = "SIMULATE:" + type.toUpperCase();
            runSimulation(type);
        }

        function runSimulation(type) {
            document.getElementById('loading-ui').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Simulating Forensic Pattern: " + type.toUpperCase();
            
            setTimeout(() => {
                let mockData = {};
                
                if (type === 'bundle') {
                    mockData = {
                        score: 12,
                        title: "SUPPLY BUNDLE DETECTED",
                        desc: "High Risk of Rug Pull. Supply is centralized in connected wallets.",
                        verdictColor: "border-red-500",
                        scoreColor: "text-red-500",
                        top10: "92%", dev: "0%", unique: 45,
                        clusterData: [10, 10, 10, 10, 10, 10, 10, 10], // Even split = bundle
                        volumeData: [100, 120, 110, 130], // Normal volume
                        insight: "Notice the spider-web pattern. Wallets A, B, and C were funded by the same Deployer."
                    };
                } else if (type === 'wash') {
                    mockData = {
                        score: 35,
                        title: "ARTIFICIAL VOLUME",
                        desc: "Wash Trading Detected. Volume is high but unique traders are low.",
                        verdictColor: "border-orange-500",
                        scoreColor: "text-orange-500",
                        top10: "20%", dev: "5%", unique: 12,
                        clusterData: [50, 5, 5, 2, 1, 37], // Dispersed
                        volumeData: [5000, 5000, 5000, 5000], // Flat bars = bot
                        insight: "The volume bars are perfectly flat, indicating a bot buying and selling to itself."
                    };
                } else {
                    mockData = {
                        score: 98,
                        title: "LOW RISK ASSET",
                        desc: "Organic distribution and healthy trading behavior.",
                        verdictColor: "border-green-500",
                        scoreColor: "text-green-500",
                        top10: "12%", dev: "1.5%", unique: 4201,
                        clusterData: [5, 2, 1, 10, 20, 15, 5, 42], // Organic
                        volumeData: [120, 340, 210, 450], // Organic waves
                        insight: "No wallet clusters detected. Supply is well distributed."
                    };
                }
                
                renderData(mockData);
            }, 1500);
        }

        function renderData(data) {
            document.getElementById('loading-ui').classList.add('hidden');
            document.getElementById('results-ui').classList.remove('hidden');

            // Verdict
            document.getElementById('verdict-title').innerText = data.title;
            document.getElementById('verdict-desc').innerText = data.desc;
            document.getElementById('verdict-score').innerText = data.score;
            document.getElementById('verdict-score').className = `text-5xl font-mono font-bold ${data.scoreColor}`;
            document.getElementById('verdict-banner').className = `card p-6 mb-8 flex flex-col md:flex-row justify-between items-center border-l-4 ${data.verdictColor}`;

            // Metrics
            document.getElementById('data-top10').innerText = data.top10;
            document.getElementById('data-dev').innerText = data.dev;
            document.getElementById('data-unique').innerText = data.unique;
            document.getElementById('cluster-insight').innerText = data.insight;

            // --- CHARTS (CHART.JS) ---
            
            // 1. Cluster Chart (Radar for Bundling)
            const ctxCluster = document.getElementById('clusterChart').getContext('2d');
            if(clusterChartInstance) clusterChartInstance.destroy();
            clusterChartInstance = new Chart(ctxCluster, {
                type: 'radar',
                data: {
                    labels: ['W1', 'W2', 'W3', 'W4', 'W5', 'W6', 'W7', 'W8'],
                    datasets: [{
                        label: 'Wallet Connection Strength',
                        data: data.clusterData,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: '#3B82F6',
                        borderWidth: 2,
                        pointBackgroundColor: '#fff'
                    }]
                },
                options: {
                    scales: { r: { grid: { color: '#334155' }, ticks: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });

            // 2. Volume Chart (Bar for Wash Trading)
            const ctxVol = document.getElementById('volumeChart').getContext('2d');
            if(volumeChartInstance) volumeChartInstance.destroy();
            volumeChartInstance = new Chart(ctxVol, {
                type: 'bar',
                data: {
                    labels: ['10:00', '11:00', '12:00', '13:00'],
                    datasets: [{
                        label: 'Trading Volume',
                        data: data.volumeData,
                        backgroundColor: '#10B981',
                        borderRadius: 4
                    }]
                },
                options: {
                
