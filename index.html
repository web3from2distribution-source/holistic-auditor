<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silk-Filter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        body { background-color: #0B1120; color: #E2E8F0; font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card { background: #1E293B; border: 1px solid #334155; border-radius: 8px; }
        .forensic-panel { border-left: 3px solid; }
        .panel-immutable { border-color: #3B82F6; } /* Blue for Code */
        .panel-mutable { border-color: #10B981; }   /* Green for Behavior */
        
        /* Grid Pattern Background */
        .bg-grid { background-image: radial-gradient(#334155 1px, transparent 1px); background-size: 20px 20px; }
        
        .loader { border-top-color: #10B981; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen bg-grid">

    <header class="border-b border-slate-700 bg-slate-900/80 backdrop-blur sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded">
                    <i data-lucide="shield-search" class="text-white w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-none tracking-tight">CHAIN FORENSICS</h1>
                    <div class="text-[10px] text-slate-400 mono">V3.2.0 // SECURE PROD</div>
                </div>
            </div>
            <button id="connect-btn" onclick="connectWallet()" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 text-xs font-bold py-2 px-4 rounded transition flex items-center gap-2">
                <i data-lucide="wallet" class="w-4 h-4"></i> CONNECT SOLANA
            </button>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">

        <div class="max-w-2xl mx-auto mb-12 text-center">
            <h2 class="text-3xl font-extrabold text-white mb-2">Reveal The Invisible.</h2>
            <p class="text-slate-400 mb-6 text-sm">Triangulate Code, Supply, and Behavior to detect "Soft Rugs" other scanners miss.</p>
            
            <div class="relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-green-600 rounded-lg blur opacity-25 group-hover:opacity-50 transition duration-1000"></div>
                <div class="relative flex">
                    <input type="text" id="token-input" placeholder="Enter Token Address (Solana)..." 
                        class="w-full bg-slate-900 border border-slate-700 text-white px-6 py-4 rounded-l-lg focus:outline-none focus:border-blue-500 mono">
                    <button onclick="runPaidAudit()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-8 py-4 rounded-r-lg flex items-center gap-2 transition">


                             <span>SCAN</span>
                        <span class="bg-blue-800 text-[10px] py-1 px-2 rounded ml-1">0.002 SOL</span>
                    </button>
                </div>
            </div>
            
            <div class="mt-4 text-xs text-slate-500 mono">
                * Secure Payment: 0.002 SOL required for forensic data API access.
            </div>
        </div>

        <div id="loading-ui" class="hidden fixed inset-0 bg-slate-900/90 z-40 flex flex-col items-center justify-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-700 h-16 w-16 mb-6"></div>
            <div class="text-xl font-bold text-white mb-2 animate-pulse" id="loading-text">Processing Payment...</div>
            <div class="text-sm text-slate-400 mono">Triangulating On-Chain Data Points</div>
        </div>

        <div id="results-ui" class="hidden">
            
            <div class="card p-6 mb-8 flex flex-col md:flex-row justify-between items-center border-l-4" id="verdict-banner">
                <div>
                    <div class="text-sm text-slate-400 uppercase tracking-widest font-bold mb-1">Forensic Verdict</div>
                    <h2 class="text-3xl font-bold text-white" id="verdict-title">--</h2>
                    <p class="text-sm text-slate-400 mt-1 max-w-xl" id="verdict-desc">--</p>
                </div>
                <div class="text-right mt-4 md:mt-0">
                    <div class="text-5xl font-mono font-bold" id="verdict-score">--</div>
                    <div class="text-xs text-slate-500 uppercase mt-1">Safety Score</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                <div class="space-y-6">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="box" class="text-blue-500"></i>
                        <h3 class="font-bold text-slate-200">THEOLOGY A: CODE & SUPPLY</h3>
                    </div>

                    <div class="card p-5 forensic-panel panel-immutable">
                        <div class="flex justify-between mb-4">
                            <h4 class="font-bold text-sm text-slate-300">Supply Clustering (The "Bundle")</h4>
                            <span class="text-xs bg-slate-800 px-2 py-1 rounded text-blue-400 border border-blue-900/30">Forensic Angle A</span>
                        </div>
                        <div class="h-64 relative bg-slate-900/50 rounded flex items-center justify-center overflow-hidden">
                            <canvas id="clusterChart"></canvas>
                        </div>
                        <div class="mt-4 text-xs text-slate-400 bg-slate-800 p-3 rounded border border-slate-700">
                            <strong class="text-blue-400">Why this matters:</strong> 
                            <span id="cluster-insight">Scammers split tokens into 20+ wallets to look decentralized. Our algorithm detects if these wallets are connected.</span>
                        </div>
                    </div>

                    <div class="card p-5">
                        <h4 class="font-bold text-sm text-slate-300 mb-4">Holder Concentration</h4>
                        <div class="flex gap-4 items-center">
                            <div class="w-1/3">
                                <canvas id="holderPieChart"></canvas>
                            </div>
                            <div class="w-2/3 space-y-3 text-sm">
                                <div class="flex justify-between border-b border-slate-700 pb-1">
                                    <span class="text-slate-400">Top 10 Holders</span>
                                    <span class="font-mono text-white" id="data-top10">--%</span>
                                </div>
                                <div class="flex justify-between border-b border-slate-700 pb-1">
                                    <span class="text-slate-400">Code Audit</span>
                                    <span class="font-mono text-white" id="data-code-status">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Holders Scanned</span>
                                    <span class="font-mono text-white" id="data-unique">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="activity" class="text-green-500"></i>
                        <h3 class="font-bold text-slate-200">THEOLOGY B: HUMAN BEHAVIOR</h3>
                    </div>

                    <div class="card p-5 forensic-panel panel-mutable">
                        <div class="flex justify-between mb-4">
                            <h4 class="font-bold text-sm text-slate-300">Volume vs. Reality (Wash Trading)</h4>
                            <span class="text-xs bg-slate-800 px-2 py-1 rounded text-green-400 border border-green-900/30">Forensic Angle B</span>
                        </div>
                        <div class="h-48">
                            <canvas id="volumeChart"></canvas>
                        </div>
                        <div class="mt-4 text-xs text-slate-400 bg-slate-800 p-3 rounded border border-slate-700">
                            <strong class="text-green-400">Why this matters:</strong> 
                            <span id="volume-insight">High volume with low unique traders means the Dev is trading with himself to fake popularity.</span>
                        </div>
                    </div>

                    <div class="card p-5">
                        <h4 class="font-bold text-sm text-slate-300 mb-4">Market Vitality</h4>
                        <div class="space-y-2">
                            <div class="grid grid-cols-2 text-sm">
                                <div class="text-slate-500">Price (USD)</div>
                                <div class="text-right font-mono" id="data-price">--</div>
                            </div>
                            <div class="grid grid-cols-2 text-sm">
                                <div class="text-slate-500">24h Volume</div>
                                <div class="text-right font-mono" id="data-vol">--</div>
                            </div>
                            <div class="grid grid-cols-2 text-sm">
                                <div class="text-slate-500">1h Change</div>
                                <div class="text-right font-mono" id="data-change">--</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </main>


       <script>
        // --- CONFIGURATION ---
        // Your Render Backend URL
        const BACKEND_URL = "https://holistic-auditor.onrender.com"; 
        
        // !!! PASTE YOUR WALLET ADDRESS HERE !!!
        const TREASURY_WALLET = "YOUR_SOLANA_WALLET_ADDRESS_HERE"; 
        
        // The Fee in SOL
        const AUDIT_FEE = 0.002; 

        // --- GLOBAL VARS ---
        let userWallet = null;
        let clusterChartInstance = null;
        let volumeChartInstance = null;
        let holderChartInstance = null;

        // --- WALLET ---
        async function connectWallet() {
            if (window.solana && window.solana.isPhantom) {
                try {
                    const resp = await window.solana.connect();
                    userWallet = resp.publicKey.toString();
                    document.getElementById('connect-btn').innerText = "CONNECTED: " + userWallet.slice(0,4) + "..";
                    document.getElementById('connect-btn').classList.replace("bg-slate-800", "bg-blue-700");
                } catch (e) { console.error("User rejected connection"); }
            } else {
                alert("Please install Phantom Wallet to pay for audits.");
                window.open("https://phantom.app/", "_blank");
            }
        }

        // --- PAYMENT & EXECUTION ---
        async function runPaidAudit() {
            const address = document.getElementById('token-input').value;
            if(!address) return alert("Enter Token Address");

            // 1. CHECK WALLET
            if(!userWallet) await connectWallet();
            if(!userWallet) return;

            document.getElementById('loading-ui').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "Processing Payment...";

            try {
                // 2. SETUP TRANSACTION
                const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: new solanaWeb3.PublicKey(userWallet),
                        toPubkey: new solanaWeb3.PublicKey(TREASURY_WALLET),
                        lamports: AUDIT_FEE * solanaWeb3.LAMPORTS_PER_SOL
                    })
                );
                
                const { blockhash } = await connection.getLatestBlockhash();
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = new solanaWeb3.PublicKey(userWallet);

                // 3. SEND & CONFIRM
                const { signature } = await window.solana.signAndSendTransaction(transaction);
                document.getElementById('loading-text').innerText = "Verifying Payment on Chain...";
                
                // We confirm on client side first to ensure block propagation
                await connection.confirmTransaction(signature, 'confirmed');

                // 4. RUN REAL SECURE AUDIT
                await runRealBackendAudit(address, signature);

            } catch(e) {
                console.error(e);
                alert("Transaction Failed or Cancelled: " + e.message);
                document.getElementById('loading-ui').classList.add('hidden');
            }
        }


                // --- THE REAL BACKEND CALL (WITH SIGNATURE) ---
        async function runRealBackendAudit(address, signature) {
            document.getElementById('loading-text').innerText = "Triangulating Live Forensic Data...";
            
            try {
                // We send the signature so the backend can verify payment
                const res = await fetch(`${BACKEND_URL}/audit`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        address: address,
                        signature: signature 
                    })
                });
                
                const data = await res.json();
                
                // If payment verification failed (402 Error)
                if (res.status === 402) {
                    throw new Error("Payment Verification Failed: " + data.error);
                }
                
                if(!res.ok) throw new Error("Server Error");

                // --- DATA MAPPING ---
                const supply = data.pillars.supply || {};
                const market = data.pillars.market || {};
                const code = data.pillars.code || {};

                // Generate Description from Risks
                const allRisks = [...(supply.risks || []), ...(market.risks || []), ...(code.risks || [])];
                const riskDesc = allRisks.length > 0 ? "FLAGGED: " + allRisks.join(". ") : "No critical anomalies detected in forensic scan.";

                renderData({
                    score: data.overall_score,
                    title: data.verdict_title,
                    desc: riskDesc,
                    
                    // Style
                    verdictColor: data.overall_score > 80 ? "border-green-500" : "border-red-500",
                    scoreColor: data.overall_score > 80 ? "text-green-500" : "text-red-500",
                    
                    // Metrics
                    top10: (supply.top10_percent || 0) + "%",
                    unique: (supply.holders_count || 0) + " (Top 20 scanned)",
                    codeStatus: code.score_penalty > 0 ? "ISSUES FOUND" : "CLEAN",
                    
                    price: market.price ? `$${market.price}` : "N/A",
                    vol: market.volume ? `$${parseFloat(market.volume).toLocaleString()}` : "N/A",
                    change: (market.change || 0) + "%",

                    // Charts (Visuals based on Score)
                    // Note: In v4 we can pass raw arrays from Python, here we infer pattern from score
                    clusterData: data.overall_score < 50 ? [10,10,10,10,10,10] : [5,2,20,1,15,4], 
                    volumeData: data.overall_score < 50 ? [100,100,100,100] : [50, 120, 80, 150],
                    insight: allRisks.length > 0 ? allRisks[0] : "Supply and volume appear organic."
                });

            } catch (e) {
                alert("Audit Error: " + e.message + ". (If Render is sleeping, wait 30s and try again)");
                document.getElementById('loading-ui').classList.add('hidden');
            }
        }

        // --- RENDER UI ---
        function renderData(data) {
            document.getElementById('loading-ui').classList.add('hidden');
            document.getElementById('results-ui').classList.remove('hidden');

            // Text Updates
            document.getElementById('verdict-title').innerText = data.title;
            document.getElementById('verdict-desc').innerText = data.desc;
            document.getElementById('verdict-score').innerText = data.score;
            document.getElementById('verdict-score').className = `text-5xl font-mono font-bold ${data.scoreColor}`;
            document.getElementById('verdict-banner').className = `card p-6 mb-8 flex flex-col md:flex-row justify-between items-center border-l-4 ${data.verdictColor}`;

            document.getElementById('data-top10').innerText = data.top10;
            document.getElementById('data-code-status').innerText = data.codeStatus;
            document.getElementById('data-unique').innerText = data.unique;
            document.getElementById('cluster-insight').innerText = data.insight;
            
            document.getElementById('data-price').innerText = data.price;
            document.getElementById('data-vol').innerText = data.vol;
            document.getElementById('data-change').innerText = data.change;

            // Chart Logic
            updateCharts(data);
        }


           function updateCharts(data) {
            // Cluster Chart
            const ctxCluster = document.getElementById('clusterChart').getContext('2d');
            if(clusterChartInstance) clusterChartInstance.destroy();
            clusterChartInstance = new Chart(ctxCluster, {
                type: 'radar',
                data: {
                    labels: ['W1', 'W2', 'W3', 'W4', 'W5', 'W6'],
                    datasets: [{
                        label: 'Connection Strength',
                        data: data.clusterData,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: '#3B82F6',
                        borderWidth: 2,
                        pointBackgroundColor: '#fff'
                    }]
                },
                options: { scales: { r: { grid: { color: '#334155' }, ticks: { display: false } } }, plugins: { legend: { display: false } } }
            });

            // Volume Chart
            const ctxVol = document.getElementById('volumeChart').getContext('2d');
            if(volumeChartInstance) volumeChartInstance.destroy();
            volumeChartInstance = new Chart(ctxVol, {
                type: 'bar',
                data: {
                    labels: ['1h', '2h', '3h', '4h'],
                    datasets: [{
                        data: data.volumeData,
                        backgroundColor: '#10B981',
                        borderRadius: 4
                    }]
                },
                options: { scales: { y: { grid: { color: '#334155' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });

            // Pie Chart
            const ctxPie = document.getElementById('holderPieChart').getContext('2d');
            if(holderChartInstance) holderChartInstance.destroy();
            const top10Val = parseInt(data.top10) || 0;
            holderChartInstance = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['Top 10', 'Others'],
                    datasets: [{
                        data: [top10Val, 100 - top10Val],
                        backgroundColor: ['#EF4444', '#3B82F6'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '70%', plugins: { legend: { display: false } } }
            });
        }
        
        lucide.createIcons();
    </script>
</body>
</html>
